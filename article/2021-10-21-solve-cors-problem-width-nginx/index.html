<!DOCTYPE html><html lang="zh-cn" data-color-mode="light"><head><meta charSet="utf-8"/><link rel="shortcut icon" href="/medias/favicon.png"/><meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/><meta content="on" http-equiv="x-dns-prefetch-control"/><meta content="telephone=no" name="format-detection"/><title>使用nginx修改接口响应头解决跨域问题 | liyang&#x27;s  blog</title><meta name="keywords" content="nginx 跨域"/><meta name="description" content="跨域这个问题对于前端来说是老生常谈了，搜索一下相关问题就会出现一堆解决方案，有的方法是通过使用nginx反向代理来解决跨域问题，不过这种方是只存在两个域的情况下，比如说我们的前端页面发布在A服务器上，然后接口是B服务器提供，我们在A服务器上通过nginx反向代理请求B服务器的接口。不过我最近碰到的问题要比这个复杂点，现在我们有三个域，我们多了一个第三方的接口在C服务器上，这个接口是第三方提供，不受……"/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/59727fef85d99607.css" as="style"/><link rel="stylesheet" href="/_next/static/css/59727fef85d99607.css" data-n-g=""/><noscript data-n-css=""></noscript></head><body><div id="__next" data-reactroot=""><div class="blog-header min-w-full"><div class="container max-w-screen-lg px-2 clear-both"><div class="block text-center sm:inline-block sm:text-left "><div class=" inline-block align-top rounded-full my-2 mr-2 w-8 h-8 overflow-hidden bg-blue-400"><img class="site-logo" src="/medias/avatar.jpg" alt=""/></div><span class=" inline-block align-top mt-2.5 text-xl">liyang&#x27;s  blog</span></div><div class="block text-center sm:inline-block sm:text-left sm:float-right"><a class="inline-block nav-link py-3 px-2" href="/">首页</a><a class="inline-block nav-link py-3 px-2" href="/archives/">归档</a><a class="inline-block nav-link py-3 px-2" href="/gallery/">相册</a><a class="inline-block nav-link py-3 px-2" href="/about/">关于</a><span class="inline-block nav-link py-3 px-2" id="btn_toggle_theme" title="切换暗色模式"><i class="theme-icon"></i></span></div></div></div><div class="blog-body pt-10 pb-10"><div class="container max-w-screen-lg px-3"><main class="flex"><article class="article-content mb-5 rounded p-5 w-full "><h1 class="text-xl md:text-2xl lg:text-2xl font-bold tracking-tighter leading-tight md:leading-none mb-6 text-center md:text-left">使用nginx修改接口响应头解决跨域问题</h1><p class="mb-5 text-sm"><span class="mr-3">发布日期：<!-- -->2021-10-21</span><span>文章字数：<!-- -->0.8<!-- -->K</span></p><div class="mx-auto"><div class="markdown-body"><p>跨域这个问题对于前端来说是老生常谈了，搜索一下相关问题就会出现一堆解决方案，有的方法是通过使用nginx反向代理来解决跨域问题，不过这种方是只存在两个域的情况下，比如说我们的前端页面发布在A服务器上，然后接口是B服务器提供，我们在A服务器上通过nginx反向代理请求B服务器的接口。不过我最近碰到的问题要比这个复杂点，现在我们有三个域，我们多了一个第三方的接口在C服务器上，这个接口是第三方提供，不受控制，而且因为一些原因配置了白名单，只能通过B服务器的ip来访问，这样我们只能把nginx放在B服务器上来转发C服务器的接口。</p>
<p>nginx配置如下</p>
<pre><code>location /Api/ &#123;
         proxy_pass http://serverC/Api/;
       &#125;
</code></pre>
<p>配置好了后，我们可以通过B服务器来访问C服务的接口了，但是浏览器却报了一个错：</p>
<p><img src="https://images.liyangzone.com/article_img/%E6%8A%80%E6%9C%AF%E7%9B%B8%E5%85%B3/%E5%85%B1%E7%94%A8/net_err.png"></p>
<pre><code>Access to XMLHttpRequest at &#39;http://XXX.com/API&#39; from origin &#39;http://localhost:8080&#39; has been blocked by CORS policy: The value of the &#39;Access-Control-Allow-Origin&#39; header in the response must not be the wildcard &#39;*&#39; when the request&#39;s credentials mode is &#39;include&#39;. The credentials mode of requests initiated by the XMLHttpRequest is controlled by the withCredentials attribute.
</code></pre>
<p>翻译过来就是：在localhost:8080向发起的XMLHttpRequest请求被CORS策略阻止了，当请求的凭证模式为’include’时，响应头’Access-Control-Allow-Origin’的值不能是通配符*，XMLHttpRequest 发起的请求的凭证模式由 withCredentials 属性控制</p>
<p>withCredentials这个属性你可以简单理解为跨域请求是否带cookie，默认是false，这里我们是需要cookie的所以必须设成true，但是设置为true的话，接口返回的响应头’Access-Control-Allow-Origin’的值就不能是*，必须是请求方的地址。在vue项目中，这个值一般在封装axios的代码里：</p>
<pre><code>const service = axios.create(&#123;
  baseURL: &#39;&#39;, // url = base url + request url
  withCredentials: true, // 配置跨域请求是否带cookies
  timeout: 300000 // request timeout
&#125;)
</code></pre>
<p>因为这个C服务器的接口不受控制，所以不能通过代码层面来解决，那么能不能使用nginx来修改这个响应头呢，答案是肯定的，查了一些资料并试验后，我成功解决了这个问题，首先我们通过配置proxy_hide_header把C接口的响应头Access-Control-Allow-Origin给去掉，然后再加上一个正确的响应头，来达到修改的效果，具体配置如下：</p>
<pre><code>location /Api/ &#123;
  # 配置OPTIONS请求，返回204状态  
  if ($request_method = &#39;OPTIONS&#39;) &#123;
    add_header Access-Control-Allow-Credentials true;
    add_header Access-Control-Allow-Origin $http_origin;
    add_header Access-Control-Allow-Methods &#39;GET, POST, OPTIONS&#39;;
    add_header Access-Control-Allow-Headers &#39;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&#39;;
            return 204;
  &#125;
  proxy_pass http://serverC/Api/;
  proxy_hide_header Access-Control-Allow-Credentials; # 隐藏错误响应头
  proxy_hide_header Access-Control-Allow-Origin; # 隐藏错误响应头
  add_header Access-Control-Allow-Credentials true; # 添加正确响应头
  add_header Access-Control-Allow-Origin $http_origin; # 添加正确响应头
&#125;
</code></pre>
<p>配置中除了Access-Control-Allow-Origin还有个Access-Control-Allow-Credentials响应头，这个值也是必须的，而且必须为true，加上上面的配置之后就能愉快地开发了。</p>
</div><p class="date-info pt-8 font-bold leading-10 text-center hidden">本文发布于天前，文中所描述的信息可能已发生改变</p></div></article></main></div></div><footer class="blog-footer bg-neutral-50 border-neutral-200"><div class="container max-w-screen-lg px-3"><div class="md:flex justify-between block text-sm py-2"><div class="py-1 mx-3 text-center">Copyright © 2019 - 2022 <!-- -->liyang&#x27;s  blog<a href="http://beian.miit.gov.cn/"> 豫ICP备19028870号 </a></div><div class="py-1 mx-3 text-center"> Powered by<a href="https://nextjs.org/"> Next.js </a>&amp;<a href="https://hexo.io/"> Hexo </a>Created by liyang</div></div></div></footer></div></body><script id="DarkModeScript">
    let html = document.documentElement;
    let  colorScheme = localStorage.getItem('colorScheme')
    if(colorScheme&&colorScheme=='dark'){
      html.setAttribute('data-color-mode', 'dark')
    } else {
      html.setAttribute('data-color-mode', 'light')
    }
    let btn_toggle_theme = document.querySelector('#btn_toggle_theme');
    btn_toggle_theme.addEventListener('click', function () {
    let theme = html.dataset.colorMode;
      if (theme == 'light') {
        html.setAttribute('data-color-mode', 'dark')
        localStorage.setItem('colorScheme','dark');
      } else if (theme == 'dark') {
        html.setAttribute('data-color-mode', 'light')
        localStorage.setItem('colorScheme','light');
      }
    })</script><script id="DynamicLoadScript">
function PromiseForEach(arr, cb) {
    let realResult = []
    let result = Promise.resolve()
    arr.forEach((a, index) => {
      result = result.then(() => {
        return cb(a).then((res) => {
          realResult.push(res)
        })
      })
    })
    return result.then(() => {
      return realResult
    })
 }
function addScript(url) {
   return new Promise((resolve, reject) => {
     let script = document.createElement('script');
     script.src = url;
     document.documentElement.appendChild(script);
     script.onload = ()=>{
       return resolve('success')
     }
     script.onerror = ()=>{
       return reject('error')
     }
   })
 }     
function AddCss(url) {
      document.head.insertAdjacentHTML("beforeend", `<link rel="stylesheet" href="${url}">`);
}
</script><script id="ArticleTocScript">
       window.articleDate = '2021-10-21';
      let tocLinks = document.querySelectorAll('.toc-text');
      let targetLinks = document.querySelectorAll('.headerlink')
      tocLinks.forEach(function (link) {
        link.addEventListener('click', function (event) {
        let target = event.target
        event.preventDefault()
        event.stopPropagation()
        let parent = target.parentNode;
        let hash = decodeURI(parent.hash);
        let targetLink = Array.prototype.find.call(targetLinks, function (item) {
          return item.getAttribute('href') == hash
        })
        let top = targetLink.offsetTop
        window.scrollTo(0, top - 100)
        })
      })
      let dateInfoEle = document.querySelector('.date-info');
      var articleDate = new Date(window.articleDate)
    if(new Date().getTime()-articleDate.getTime()>180 * 24 * 3600 *1000){
      let date = Math.ceil((new Date().getTime()-articleDate.getTime())/24/3600/1000)
      dateInfoEle.style.display = 'block';
      dateInfoEle.innerText = `本文发布于${date}天前，文中所描述的信息可能已发生改变。`
    }
addScript('https://unpkg.com/@highlightjs/cdn-assets@11.5.0/highlight.min.js').then(res => {
   document.querySelectorAll('pre code').forEach((el) => {
    hljs.highlightElement(el);
  });
})     
      </script><script id="StatisticScript">
let runningOnBrowser = typeof window !== "undefined";
    let isBot = runningOnBrowser && !("onscroll" in window) || typeof navigator !== "undefined" && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
let supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;
    if(!isBot&&supportsIntersectionObserver){
      if(!navigator.userAgent.includes('Chrome/78')){
        addScript('https://hm.baidu.com/hm.js?3123469f7f81d45d6c4cd4a6a84ccf68');
        addScript('https://js.users.51.la/21306481.js');
      }
    }
  </script></html>